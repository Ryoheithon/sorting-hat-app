# 組み分け帽子アプリ 仕様書

## 概要

「組み分け帽子アプリ」は、ハリーポッターをモチーフにした寮組み分けアプリケーションです。ユーザーが名前を入力すると、「長谷川魔法学校」の4つの寮（グリフィンドール、ハッフルパフ、レイブンクロー、スリザリン）のいずれかにランダムに組み分けされます。

## 技術スタック

- **フロントエンド**
  - Next.js 15.2.1
  - React 19.0.0
  - TypeScript
  - Tailwind CSS
  - Framer Motion（アニメーション）
  - Three.js / React Three Fiber（3Dレンダリング）

- **バックエンド**
  - Next.js API Routes
  - Supabase（データベース）
  - Zod（バリデーション）

## 機能仕様

### 1. メイン画面

- 組み分け帽子の3Dモデルを表示
- ユーザー名入力フォーム
- 過去の組み分け結果履歴表示

### 2. 名前入力・組み分け処理

- 名前は2文字以上20文字以下の制限あり
- 入力があると組み分け処理が実行される
- 組み分けは各寮の人数が均等になるように調整される（各寮最大8名まで）
- 全ての寮が8名に達した場合はエラーを表示

### 3. 結果表示画面

- 組み分けられた寮の名前と色を表示
- 寮に応じた背景色やスタイルが適用される
- トップ画面に戻るリンクを表示

### 4. 組み分け履歴表示

- 最新50件の組み分け結果を表示
- 日時の降順で表示

## データモデル

### SortingResult
- **id**: UUID（一意の識別子）
- **name**: string（ユーザーの名前）
- **house**: string（'Gryffindor' | 'Hufflepuff' | 'Ravenclaw' | 'Slytherin'）
- **created_at**: timestamp（組み分け日時）

## API仕様

### 1. 組み分け実行 API

- **エンドポイント**: `/api/sorting`
- **メソッド**: POST
- **リクエストボディ**:
  ```json
  {
    "name": "ユーザー名"
  }
  ```
- **レスポンス**:
  ```json
  {
    "success": true,
    "data": {
      "id": "組み分け結果ID",
      "name": "ユーザー名",
      "house": "割り当てられた寮",
      "created_at": "作成日時"
    }
  }
  ```
- **エラーレスポンス**:
  ```json
  {
    "error": "エラーメッセージ"
  }
  ```

### 2. 組み分け履歴取得 API

- **エンドポイント**: `/api/sorting-history`
- **メソッド**: GET
- **レスポンス**:
  ```json
  {
    "success": true,
    "data": [
      {
        "id": "組み分け結果ID",
        "name": "ユーザー名",
        "house": "割り当てられた寮",
        "created_at": "作成日時"
      },
      ...
    ]
  }
  ```

## 組み分けロジック

1. 各寮の現在のメンバー数をデータベースから取得
2. 8名未満の寮だけを候補として抽出
3. 候補の中からランダムに1つの寮を選択
4. 全ての寮が8名に達している場合はエラーを返す

## 実装詳細

### コンポーネント構成

- **SortingHat**: 3Dの組み分け帽子モデルを表示
- **NameForm**: ユーザー名入力と送信処理
- **SortingResult**: 組み分け結果の表示
- **SortingHistory**: 過去の組み分け結果リスト

### 画面遷移

1. トップページ（`/`）：組み分け帽子と名前入力フォームを表示
2. 結果ページ（`/result?id=xxx`）：組み分け結果を表示

### 動作環境

- モバイル端末およびデスクトップブラウザに対応
- レスポンシブデザイン

## 環境変数

`.env.local`ファイルに以下の環境変数を設定する必要があります：

```
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

## 開発方法

```bash
# 開発サーバー起動
npm run dev

# ビルド
npm run build

# 本番サーバー起動
npm run start

# リント実行
npm run lint
```

## インストール方法

1. リポジトリをクローン
2. 依存関係をインストール：`npm install`
3. Supabaseプロジェクトを作成し環境変数を設定
4. データベースに`sorting_results`テーブルを作成
5. 開発サーバーを起動：`npm run dev`